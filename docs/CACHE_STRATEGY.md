# Redis ç¼“å­˜ç­–ç•¥ä¼˜åŒ–

æœ¬æ–‡æ¡£ä»‹ç»äº†é¡¹ç›®ä¸­å®ç°çš„é«˜çº§ Redis ç¼“å­˜ç­–ç•¥ï¼ŒåŒ…æ‹¬ç¼“å­˜é¢„çƒ­ã€åŠ¨æ€ TTL å’Œé™çº§ç­–ç•¥ã€‚

## ğŸ“‹ ç›®å½•

- [åŠŸèƒ½ç‰¹æ€§](#åŠŸèƒ½ç‰¹æ€§)
- [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
- [API ç«¯ç‚¹](#api-ç«¯ç‚¹)
- [ç¼“å­˜ç­–ç•¥è¯¦è§£](#ç¼“å­˜ç­–ç•¥è¯¦è§£)
- [ç›‘æ§å’Œè°ƒè¯•](#ç›‘æ§å’Œè°ƒè¯•)
- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)

---

## åŠŸèƒ½ç‰¹æ€§

### 1. ğŸ”¥ ç¼“å­˜é¢„çƒ­ (Cache Warmup)

åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨é¢„åŠ è½½çƒ­é—¨æ•°æ®ï¼Œå‡å°‘å†·å¯åŠ¨æ—¶çš„å“åº”å»¶è¿Ÿã€‚

**ç‰¹ç‚¹ï¼š**
- å»¶è¿Ÿ 3 ç§’å¯åŠ¨ï¼Œé¿å…å½±å“åº”ç”¨å¯åŠ¨é€Ÿåº¦
- è‡ªåŠ¨æ£€æµ‹å·²æœ‰ç¼“å­˜ï¼Œé¿å…é‡å¤åŠ è½½
- æ”¯æŒæ‰¹é‡é¢„çƒ­ï¼Œæå‡åŠ è½½æ•ˆç‡

**ä»£ç ä½ç½®ï¼š**
```typescript
// apps/api/src/modules/news/services/ai-analyzer.service.ts
async onModuleInit() {
  setTimeout(() => {
    this.warmupCache();
  }, 3000);
}
```

### 2. â±ï¸ åŠ¨æ€ TTL (Dynamic TTL)

æ ¹æ®å†…å®¹çƒ­åº¦è‡ªåŠ¨è°ƒæ•´ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼Œçƒ­é—¨å†…å®¹ç¼“å­˜æ›´ä¹…ã€‚

**çƒ­åº¦è®¡ç®—å…¬å¼ï¼š**
```typescript
hotScore = viewCount Ã— 1 + impactScore Ã— 10 + bookmarkCount Ã— 5
```

**TTL ç­–ç•¥ï¼š**
| çƒ­åº¦åˆ†æ•° | TTL | é€‚ç”¨åœºæ™¯ |
|---------|-----|---------|
| â‰¥ 200 | 2 å°æ—¶ | è¶…çƒ­é—¨å†…å®¹ |
| â‰¥ 100 | 1 å°æ—¶ | çƒ­é—¨å†…å®¹ |
| â‰¥ 50 | 45 åˆ†é’Ÿ | ä¸­ç­‰çƒ­åº¦ |
| < 50 | 30 åˆ†é’Ÿ | æ™®é€šå†…å®¹ |

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```typescript
await this.cacheStrategy.setWithDynamicTTL(cacheKey, data, {
  viewCount: 150,
  impactScore: 8,
  bookmarkCount: 20
});
// çƒ­åº¦åˆ†æ•° = 150 + 80 + 100 = 330 â†’ TTL = 2å°æ—¶
```

### 3. ğŸ›¡ï¸ ç¼“å­˜é™çº§ (Cache Degradation)

Redis æ•…éšœæ—¶è‡ªåŠ¨é™çº§åˆ°å†…å­˜ç¼“å­˜ï¼Œä¿è¯æœåŠ¡ 100% å¯ç”¨ã€‚

**é™çº§ç­–ç•¥ï¼š**
1. **è¯»å–é¡ºåºï¼š** Redis â†’ å†…å­˜ç¼“å­˜ â†’ æ•°æ®åº“
2. **åŒå†™ç­–ç•¥ï¼š** åŒæ—¶å†™å…¥ Redis å’Œå†…å­˜ç¼“å­˜
3. **è‡ªåŠ¨æ¸…ç†ï¼š** æ¯ 60 ç§’æ¸…ç†è¿‡æœŸçš„å†…å­˜ç¼“å­˜

**é™çº§æµç¨‹ï¼š**
```mermaid
graph LR
    A[è¯·æ±‚] --> B{Redis å¯ç”¨?}
    B -->|æ˜¯| C[ä» Redis è¯»å–]
    B -->|å¦| D[ä»å†…å­˜ç¼“å­˜è¯»å–]
    C --> E{å‘½ä¸­?}
    D --> F{å‘½ä¸­?}
    E -->|æ˜¯| G[è¿”å›æ•°æ®]
    E -->|å¦| H[æŸ¥è¯¢æ•°æ®åº“]
    F -->|æ˜¯| G
    F -->|å¦| H
    H --> I[åŒå†™ç¼“å­˜]
    I --> G
```

---

## æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         CacheStrategyService            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  æ™ºèƒ½è·å– (get)                     â”‚ â”‚
â”‚  â”‚  - Redis ä¼˜å…ˆ                       â”‚ â”‚
â”‚  â”‚  - å†…å­˜ç¼“å­˜é™çº§                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  æ™ºèƒ½è®¾ç½® (set)                     â”‚ â”‚
â”‚  â”‚  - Redis + å†…å­˜åŒå†™                â”‚ â”‚
â”‚  â”‚  - åŠ¨æ€ TTL æ”¯æŒ                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ç¼“å­˜é¢„çƒ­ (warmup)                 â”‚ â”‚
â”‚  â”‚  - å•æ¡é¢„çƒ­                         â”‚ â”‚
â”‚  â”‚  - æ‰¹é‡é¢„çƒ­                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµå‘

```
åº”ç”¨å¯åŠ¨
   â†“
ç¼“å­˜é¢„çƒ­ï¼ˆå»¶è¿Ÿ 3sï¼‰
   â†“
åŠ è½½çƒ­é—¨æ–°é—»åˆ°ç¼“å­˜
   â†“
ç”¨æˆ·è¯·æ±‚ â†’ ç¼“å­˜ç­–ç•¥æœåŠ¡
   â†“
æ™ºèƒ½è·¯ç”±ï¼ˆRedis/å†…å­˜ï¼‰
   â†“
è¿”å›æ•°æ®ï¼ˆåŒå†™ç¼“å­˜ï¼‰
```

---

## API ç«¯ç‚¹

### 1. ç”Ÿæˆ AI æ–°é—»
```bash
GET /api/v1/news/ai/generate?count=8
```

**ç‰¹æ€§ï¼š**
- è‡ªåŠ¨ä½¿ç”¨ç¼“å­˜ç­–ç•¥
- æ”¯æŒå†…å­˜é™çº§
- 30 åˆ†é’Ÿç¼“å­˜

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "data": [
    {
      "title": "OpenAI Launches GPT-5",
      "titleCn": "OpenAI å‘å¸ƒ GPT-5",
      "summary": "OpenAI announces GPT-5...",
      "summaryCn": "OpenAI å®£å¸ƒæ¨å‡º GPT-5...",
      "category": "AI",
      "region": "NORTH_AMERICA",
      "impact": 95,
      "source": "OpenAI Blog"
    }
  ]
}
```

### 2. è·å–æ–°é—»è¯¦æƒ…ï¼ˆåŠ¨æ€ TTLï¼‰
```bash
GET /api/v1/news/:id
```

**ç‰¹æ€§ï¼š**
- æ ¹æ®çƒ­åº¦è‡ªåŠ¨è°ƒæ•´ TTL
- ç¼“å­˜å‘½ä¸­æ—¶å¼‚æ­¥æ›´æ–°æµè§ˆé‡
- é™çº§åˆ°å†…å­˜ç¼“å­˜

### 3. æ¸…é™¤ AI æ–°é—»ç¼“å­˜
```bash
DELETE /api/v1/news/cache/ai-news
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "message": "Successfully cleared 3 cached items",
  "data": {
    "deletedCount": 3
  }
}
```

### 4. è·å–ç¼“å­˜ç»Ÿè®¡
```bash
GET /api/v1/news/cache/stats
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "data": {
    "redis": {
      "available": true
    },
    "memory": {
      "size": 15,
      "enabled": true
    },
    "config": {
      "defaultTTL": 1800,
      "hotTTL": 3600,
      "warmupEnabled": true,
      "degradeEnabled": true
    }
  }
}
```

---

## ç¼“å­˜ç­–ç•¥è¯¦è§£

### ç¼“å­˜é”®å‘½åè§„èŒƒ

```typescript
// AI æ–°é—»ç¼“å­˜
`ai-news:${date}:count-${count}`
// ç¤ºä¾‹: ai-news:2025-11-27:count-8

// æ–°é—»è¯¦æƒ…ç¼“å­˜
`news:detail:${id}`
// ç¤ºä¾‹: news:detail:abc123
```

### ç¼“å­˜é¢„çƒ­ç­–ç•¥

#### å•æ¡é¢„çƒ­
```typescript
await cacheStrategy.warmup(async () => [
  {
    key: 'ai-news:2025-11-27:count-8',
    value: newsItems,
    ttl: 1800
  }
]);
```

#### æ‰¹é‡é¢„çƒ­ï¼ˆæ¨èï¼‰
```typescript
const items = [
  { key: 'news:detail:1', value: news1, ttl: 3600 },
  { key: 'news:detail:2', value: news2, ttl: 3600 },
  // ... æ›´å¤šé¡¹ç›®
];

await cacheStrategy.batchWarmup(items, 10); // æ¯æ‰¹ 10 æ¡
```

### åŠ¨æ€ TTL è®¡ç®—ç¤ºä¾‹

```typescript
// ç¤ºä¾‹ 1: è¶…çƒ­é—¨æ–°é—»
{
  viewCount: 500,      // Ã— 1 = 500
  impactScore: 9,      // Ã— 10 = 90
  bookmarkCount: 50    // Ã— 5 = 250
}
// hotScore = 840 â†’ TTL = 7200s (2å°æ—¶)

// ç¤ºä¾‹ 2: æ™®é€šæ–°é—»
{
  viewCount: 20,       // Ã— 1 = 20
  impactScore: 5,      // Ã— 10 = 50
  bookmarkCount: 2     // Ã— 5 = 10
}
// hotScore = 80 â†’ TTL = 2700s (45åˆ†é’Ÿ)
```

---

## ç›‘æ§å’Œè°ƒè¯•

### æ—¥å¿—çº§åˆ«

åº”ç”¨ä¼šè¾“å‡ºä»¥ä¸‹æ—¥å¿—ï¼š

```
âœ… Cache warmup completed: 8 items loaded
âœ… Cache hit from Redis: ai-news:2025-11-27:count-8
âš ï¸  Redis get failed, falling back to memory
âœ… Cache hit from memory: news:detail:abc123
ğŸ”„ Dynamic TTL for news:detail:abc123: 3600s (hotScore: 120)
ğŸ§¹ Memory cache cleanup: removed 5 expired items
```

### ç¼“å­˜ç›‘æ§æŒ‡æ ‡

å®šæœŸè°ƒç”¨ `/api/v1/news/cache/stats` ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š

| æŒ‡æ ‡ | è¯´æ˜ | å¥åº·å€¼ |
|------|------|--------|
| `redis.available` | Redis è¿æ¥çŠ¶æ€ | `true` |
| `memory.size` | å†…å­˜ç¼“å­˜æ¡ç›®æ•° | < 1000 |
| `memory.enabled` | é™çº§ç­–ç•¥å¯ç”¨çŠ¶æ€ | `true` |

### æ€§èƒ½æµ‹è¯•

```bash
# æµ‹è¯•ç¼“å­˜é¢„çƒ­
curl http://localhost:3000/api/v1/news/cache/stats

# æµ‹è¯•ç¼“å­˜å‘½ä¸­
time curl http://localhost:3000/api/v1/news/ai/generate?count=8

# æµ‹è¯•é™çº§ç­–ç•¥ï¼ˆå…³é—­ Redisï¼‰
docker stop redis
curl http://localhost:3000/api/v1/news/ai/generate?count=8
# åº”è¯¥è¿”å›å†…å­˜ç¼“å­˜æ•°æ®ï¼Œå»¶è¿Ÿ < 100ms

# æµ‹è¯•åŠ¨æ€ TTL
curl http://localhost:3000/api/v1/news/{high-view-count-id}
# æ£€æŸ¥æ—¥å¿—ä¸­çš„ TTL å€¼
```

---

## æ€§èƒ½ä¼˜åŒ–

### ä¼˜åŒ–å»ºè®®

#### 1. è°ƒæ•´é¢„çƒ­æ—¶æœº
```typescript
// ç”Ÿäº§ç¯å¢ƒï¼šå»¶è¿Ÿæ›´é•¿ï¼Œé¿å…å½±å“å¯åŠ¨
setTimeout(() => this.warmupCache(), 10000); // 10ç§’

// å¼€å‘ç¯å¢ƒï¼šç«‹å³é¢„çƒ­
setTimeout(() => this.warmupCache(), 1000); // 1ç§’
```

#### 2. è‡ªå®šä¹‰ TTL ç­–ç•¥
```typescript
// åœ¨ cache-strategy.service.ts ä¸­è°ƒæ•´
if (hotScore >= 500) {
  ttl = 10800; // 3å°æ—¶ï¼ˆè¶…çº§çƒ­é—¨ï¼‰
}
```

#### 3. å†…å­˜ç¼“å­˜å¤§å°é™åˆ¶
```typescript
// é˜²æ­¢å†…å­˜æº¢å‡º
private setMemoryCache(key: string, value: any, ttl: number): void {
  if (this.memoryCache.size > 1000) {
    // æ¸…é™¤æœ€æ—§çš„ç¼“å­˜
    const firstKey = this.memoryCache.keys().next().value;
    this.memoryCache.delete(firstKey);
  }
  // ... è®¾ç½®ç¼“å­˜
}
```

### æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | æ— ç¼“å­˜ | Redis ç¼“å­˜ | å†…å­˜é™çº§ |
|------|--------|-----------|----------|
| é¦–æ¬¡è¯·æ±‚ | 2000ms | 2000ms | 2000ms |
| ç¼“å­˜å‘½ä¸­ | - | 50ms | 5ms |
| Redis æ•…éšœ | 2000ms | 2000ms | 5ms |
| çƒ­é—¨å†…å®¹ | 2000ms | 50ms (2h) | 5ms |

---

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. ç¼“å­˜é¢„çƒ­å¤±è´¥
**åŸå› ï¼š** GLM API å¯†é’¥æœªé…ç½®

**è§£å†³ï¼š**
```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
export GLM_API_KEY=your-api-key
```

#### 2. å†…å­˜ç¼“å­˜å ç”¨è¿‡é«˜
**åŸå› ï¼š** è¿‡æœŸæ¸…ç†å¤±è´¥

**è§£å†³ï¼š**
```typescript
// å‡å°‘æ¸…ç†é—´éš”
this.memoryCleanupInterval = setInterval(() => {
  // ...
}, 30000); // æ”¹ä¸º 30 ç§’
```

#### 3. Redis è¿æ¥å¤±è´¥ä½†æœªé™çº§
**åŸå› ï¼š** é™çº§ç­–ç•¥æœªå¯ç”¨

**è§£å†³ï¼š**
```typescript
// åœ¨ CacheStrategyService ä¸­ç¡®ä¿
this.config = {
  degradeEnabled: true, // ç¡®ä¿ä¸º true
};
```

---

## æœ€ä½³å®è·µ

1. **ç”Ÿäº§ç¯å¢ƒé…ç½®**
   - å¯ç”¨ Redis æŒä¹…åŒ–
   - è®¾ç½®åˆç†çš„å†…å­˜ä¸Šé™ï¼ˆmaxmemoryï¼‰
   - ç›‘æ§ Redis è¿æ¥çŠ¶æ€

2. **ç¼“å­˜é”®è®¾è®¡**
   - ä½¿ç”¨æœ‰æ„ä¹‰çš„å‰ç¼€ï¼ˆå¦‚ `ai-news:`, `news:detail:`ï¼‰
   - åŒ…å«æ—¥æœŸä»¥æ”¯æŒè‡ªåŠ¨è¿‡æœŸ
   - é¿å…é”®åè¿‡é•¿

3. **ç›‘æ§å‘Šè­¦**
   - Redis ä¸å¯ç”¨æ—¶å‘é€å‘Šè­¦
   - å†…å­˜ç¼“å­˜è¶…è¿‡é˜ˆå€¼æ—¶å‘Šè­¦
   - ç¼“å­˜å‘½ä¸­ç‡ä½äº 80% æ—¶ä¼˜åŒ–

4. **å®šæœŸç»´æŠ¤**
   - æ¯å¤©æ¸…ç†è¿‡æœŸç¼“å­˜
   - æ¯å‘¨åˆ†æç¼“å­˜å‘½ä¸­ç‡
   - æ¯æœˆè¯„ä¼° TTL ç­–ç•¥æ•ˆæœ

---

## ç›¸å…³æ–‡ä»¶

- `apps/api/src/common/redis/cache-strategy.service.ts` - ç¼“å­˜ç­–ç•¥æœåŠ¡
- `apps/api/src/common/redis/redis.service.ts` - Redis åŸºç¡€æœåŠ¡
- `apps/api/src/modules/news/services/ai-analyzer.service.ts` - AI æ–°é—»åˆ†ææœåŠ¡
- `apps/api/src/modules/news/controllers/news.controller.ts` - æ–°é—»æ§åˆ¶å™¨

---

**æ›´æ–°æ—¥æœŸï¼š** 2025-11-27
**ç‰ˆæœ¬ï¼š** 1.0.0

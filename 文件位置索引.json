{
  "analysis_summary": "首页数据加载流程完整分析 (2024-12-02)",
  "total_files_analyzed": 23,
  "key_findings": {
    "critical_issues": [
      "列表查询无缓存 (每页都查询DB)",
      "搜索用ILIKE全表扫描 (无tsvector索引)",
      "缺少复合索引 (多条件查询慢)"
    ],
    "performance_improvement_potential": "3-15倍"
  },
  "frontend_files": {
    "main_app": {
      "path": "apps/web/src/App.tsx",
      "lines": 610,
      "key_sections": {
        "初始化加载": { "line": 104, "length": 36 },
        "无限滚动": { "line": 207, "length": 20 },
        "手动刷新": { "line": 229, "length": 34 }
      }
    },
    "api_service": {
      "path": "apps/web/src/services/newsService.ts",
      "lines": 224,
      "functions": {
        "fetchNewsFromAPI": { "line": 18 },
        "fetchTrendingNews": { "line": 115 },
        "addBookmark": { "line": 155 },
        "getCategoryStats": { "line": 203 }
      }
    },
    "components": {
      "NewsCard": "apps/web/src/components/NewsCard.tsx",
      "DashboardStats": "apps/web/src/components/DashboardStats.tsx",
      "DailyBrief": "apps/web/src/components/DailyBrief.tsx"
    }
  },
  "backend_files": {
    "news_controller": {
      "path": "apps/api/src/modules/news/controllers/news.controller.ts",
      "lines": 343,
      "methods": {
        "getNews": { 
          "line": 34,
          "issue": "无缓存",
          "severity": "critical"
        },
        "getNewsById": {
          "line": 160,
          "status": "有缓存✅"
        },
        "getTrendingNews": { "line": 211 },
        "getCategoryStats": { "line": 255 }
      }
    },
    "cache_strategy": {
      "path": "apps/api/src/common/redis/cache-strategy.service.ts",
      "lines": 272,
      "features": [
        "双层缓存 (Redis + 内存)",
        "动态TTL",
        "自动降级"
      ]
    },
    "redis_service": {
      "path": "apps/api/src/common/redis/redis.service.ts",
      "lines": 480
    },
    "ai_analyzer": {
      "path": "apps/api/src/modules/news/services/ai-analyzer.service.ts",
      "responsibility": "使用GLM API分析新闻"
    },
    "news_scraper": {
      "path": "apps/api/src/modules/news/services/news-scraper.service.ts",
      "responsibility": "爬取RSS源，并发4个"
    },
    "redis_controller": {
      "path": "apps/api/src/common/redis/redis.controller.ts",
      "endpoints": [
        "GET /cache/stats",
        "GET /cache/report",
        "GET /cache/keys",
        "GET /cache/keyspace",
        "POST /cache/cleanup",
        "DELETE /cache/clear-all"
      ]
    }
  },
  "database": {
    "schema": "apps/api/prisma/schema.prisma",
    "models": {
      "News": {
        "fields": 28,
        "indexes": 5,
        "missing_indexes": [
          "(category, published_at DESC)",
          "(region, published_at DESC)",
          "(is_approved, is_trending, published_at)",
          "title tsvector (全文搜索)",
          "summary tsvector (全文搜索)"
        ]
      }
    }
  },
  "performance_bottlenecks": [
    {
      "rank": 1,
      "issue": "列表查询无缓存",
      "file": "apps/api/src/modules/news/controllers/news.controller.ts",
      "line": 73,
      "severity": "critical",
      "current_perf": "200ms",
      "optimized_perf": "55ms",
      "improvement": "72%",
      "solution": "添加Redis缓存，TTL=5分钟"
    },
    {
      "rank": 2,
      "issue": "搜索全表扫描",
      "file": "apps/api/src/modules/news/controllers/news.controller.ts",
      "line": 65,
      "severity": "critical",
      "current_perf": "600-2000ms",
      "optimized_perf": "100ms",
      "improvement": "85%",
      "solution": "添加tsvector全文搜索索引"
    },
    {
      "rank": 3,
      "issue": "缺少复合索引",
      "file": "apps/api/prisma/schema.prisma",
      "severity": "medium",
      "improvement": "30-50%",
      "solution": "添加(category,published_at), (region,published_at)等复合索引"
    }
  ],
  "optimization_roadmap": {
    "phase1": {
      "timeline": "1-2天",
      "tasks": [
        "添加列表查询缓存到redis",
        "创建全文搜索索引 (GIN tsvector)"
      ],
      "expected_improvement": "70-80%"
    },
    "phase2": {
      "timeline": "1周",
      "tasks": [
        "添加复合索引",
        "修改搜索为tsvector查询",
        "使用EXPLAIN ANALYZE验证"
      ]
    },
    "phase3": {
      "timeline": "持续",
      "tasks": [
        "监控缓存命中率",
        "分析慢查询",
        "定期索引维护"
      ]
    }
  },
  "analysis_documents": {
    "文档1": {
      "文件": "PERFORMANCE_ANALYSIS.md (8.2KB)",
      "内容": "详细的性能分析报告，包含代码片段、流程图、对比表格"
    },
    "文档2": {
      "文件": "首页数据加载总结.txt (7.8KB)",
      "内容": "快速参考指南，包含关键数据位置和优化方案"
    }
  },
  "cache_status": {
    "implemented": [
      "news:detail:* (动态TTL 30分钟-2小时)"
    ],
    "missing": [
      "news:list:* (最严重缺失)",
      "news:trending:*",
      "news:stats:categories"
    ]
  },
  "response_time_targets": {
    "current": {
      "首页加载": "200ms",
      "翻页": "200-300ms",
      "搜索": "600-2000ms",
      "详情初次": "150ms",
      "详情缓存": "100ms"
    },
    "target": {
      "首页加载": "55ms",
      "翻页": "55ms",
      "搜索": "100ms",
      "详情初次": "100ms",
      "详情缓存": "5ms"
    }
  }
}
